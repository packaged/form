!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Form={})}(this,function(t){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},i={exports:{}};
/*! https://mths.be/base64 v1.0.0 by @mathias | MIT license */
!function(t,i){!function(r){var n=i,a=t&&t.exports==n&&t,s="object"==typeof e&&e;s.global!==s&&s.window!==s||(r=s);var o=function(t){this.message=t};(o.prototype=new Error).name="InvalidCharacterError";var l=function(t){throw new o(t)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=/[\t\n\f\r ]/g,h={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&l("The string to be encoded contains characters outside of the Latin1 range.");for(var e,i,r,n,a=t.length%3,s="",o=-1,d=t.length-a;++o<d;)e=t.charCodeAt(o)<<16,i=t.charCodeAt(++o)<<8,r=t.charCodeAt(++o),s+=c.charAt((n=e+i+r)>>18&63)+c.charAt(n>>12&63)+c.charAt(n>>6&63)+c.charAt(63&n);return 2==a?(e=t.charCodeAt(o)<<8,i=t.charCodeAt(++o),s+=c.charAt((n=e+i)>>10)+c.charAt(n>>4&63)+c.charAt(n<<2&63)+"="):1==a&&(n=t.charCodeAt(o),s+=c.charAt(n>>2)+c.charAt(n<<4&63)+"=="),s},decode:function(t){var e=(t=String(t).replace(d,"")).length;e%4==0&&(e=(t=t.replace(/==?$/,"")).length),(e%4==1||/[^+a-zA-Z0-9/]/.test(t))&&l("Invalid character: the string to be decoded is not correctly encoded.");for(var i,r,n=0,a="",s=-1;++s<e;)r=c.indexOf(t.charAt(s)),i=n%4?64*i+r:r,n++%4&&(a+=String.fromCharCode(255&i>>(-2*n&6)));return a},version:"1.0.0"};if(n&&!n.nodeType)if(a)a.exports=h;else for(var u in h)h.hasOwnProperty(u)&&(n[u]=h[u]);else r.base64=h}(e)}(i,i.exports);var r=i.exports;const n=new Map;class a{static fromJsonObject(t){if(!n.has(t.t))throw"unrecognised type "+t.t;const e=n.get(t.t).deserialize(t.c);return e.dictionary=t.d,e}static deserialize(t){return new this}validate(t){throw"validate not implemented on "+this.constructor.name}set dictionary(t){this._dictionary=t||{}}}class s extends a{_data={};setData(t){this._data=t}getData(){return this._data}}class o{constructor(t,e){this._errors=t||[],this._potentiallyValid=e||!1}get errors(){return this._errors}get potentiallyValid(){return this._potentiallyValid}static success(){return new o([],!0)}static potentiallyValid(t=[]){return new o(t,!0)}static error(t=[]){return new o(t,!1)}combine(...t){t.forEach(t=>{t instanceof o&&(this._errors.push(...t._errors),this._potentiallyValid=this._potentiallyValid&&t._potentiallyValid)})}}function l(t,e){n.set(t,e)}class c extends a{constructor(t=[],e=!1,i=!1){super(),this._allowedValues=t||[],this._caseSensitive=!!e,this._negate=!!i}static deserialize(t){return new this(t.allowedValues||[],!!t.caseSensitive,!!t.negate)}validate(t){if(this._allowedValues.length){const e=new RegExp(this._allowedValues.join("|"),this._caseSensitive?"":"i");if(this._negate^!e.test(t))return this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Not a valid value"])}else if(this._negate^(null!==t&&""!==t))return this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Not a valid value"]);return o.success()}}class d extends a{constructor(t){super(),this._pattern=t}static deserialize(t){return new this(t.pattern)}validate(t){let e=this._pattern;if("string"==typeof e){const t=/\/(.*)\/(.*)/.exec(e);if(!t)return this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error([this.getDefaultErrorMessage()]);e=new RegExp(t[1],t[2])}return e instanceof RegExp&&e.test(t)?o.success():this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error([this.getDefaultErrorMessage()])}getDefaultErrorMessage(){return"Not a valid regular expression"}}class h extends s{constructor(t){super(),this._field=t}static deserialize(t){return new this(t.field)}validate(t){const e=this.getData(),i=e.hasOwnProperty(this._field)?e[this._field]:null;return i!==t?i?.substr(0,t?.length)===t?this._dictionary&&this._dictionary.invalid?o.potentiallyValid([this._dictionary.invalid]):o.potentiallyValid(["Values do not match"]):this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Values do not match"]):o.success()}}l("Equal",class extends a{constructor(t){super(),this._expect=t}static deserialize(t){return new this(t.expect)}validate(t){return t!==this._expect?this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Value does not match"]):o.success()}}),l("NotEqual",class extends a{constructor(t){super(),this._expect=t}static deserialize(t){return new this(t.expect)}validate(t){return t===this._expect?this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Value must not match"]):o.success()}}),l("Enum",c),l("ConstEnum",class extends c{}),l("Bool",class extends a{validate(t){if(null==t)return this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Invalid boolean value"]);if("boolean"!=typeof t)if("string"==typeof t){if(!/true|false|0|1/.test(t.toLowerCase()))return this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Invalid boolean value"])}else if("number"==typeof t&&0!==t&&1!==t)return this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Invalid boolean value"]);return o.success()}}),l("String",class extends a{constructor(t=0,e=0){super(),this._minLength=t,this._maxLength=e}static deserialize(t){return new this(t.minLength,t.maxLength)}validate(t){return"string"!=typeof t?this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Not a valid value"]):this._minLength>0&&t.length<this._minLength?this._dictionary&&this._dictionary.min?o.error([this._dictionary.min.replace("%s",this._minLength.toString())]):o.potentiallyValid(["Must be at least "+this._minLength+" characters"]):this._maxLength>0&&t.length>this._maxLength?this._dictionary&&this._dictionary.max?o.error([this._dictionary.max.replace("%s",this._maxLength.toString())]):o.error(["Must be no more than "+this._maxLength+" characters"]):o.success()}}),l("Required",class extends a{validate(t){return null==t||""===t?this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid]):o.error(["Required"]):o.success()}}),l("Multi",class extends a{constructor(t){super(),this._validators=t||[]}static deserialize(t){return new this(t.validators)}validate(t){let e=o.success();return this._validators.forEach(i=>{const r=a.fromObject(i);e.combine(r.validate(t))}),e}}),l("Regex",d),l("Email",class extends d{constructor(){super(/^[_a-zA-Z0-9+\-]+(\.[_a-zA-Z0-9+\-]+)*@[a-zA-Z0-9\-]+(\.[a-zA-Z0-9\-]+)*(\.[a-zA-Z]{2,})$/)}getDefaultErrorMessage(){return"Invalid email address"}}),l("IPv4",class extends d{constructor(){super("/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/")}getDefaultErrorMessage(){return"Invalid IPv4 address"}}),l("Confirmation",h),l("FileSize",class extends a{constructor(t=null){if(super(),null===t)throw"maxSize must be set";this._maxSize=t}static deserialize(t){return new this(t.maxSize)}validate(t){return"size"in t&&t.size>1024*this._maxSize*1024?this._dictionary&&this._dictionary.invalid?o.error([this._dictionary.invalid.replace("%s",this._maxSize.toString())]):o.error(["File upload cannot be more than "+this._maxSize+"mb in size"]):o.success()}});const u=new WeakMap;function f(t){return"checkbox"!==t.type&&"radio"!==t.type&&"file"!==t.type||t instanceof HTMLSelectElement||t.checked?t.value:"file"===t.type&&t.files[0]?t.files[0]:null}function p(t,e){return t.querySelector(`.p-form__field[handler-name="${e}"]`)}function _(t,e){const i=p(t,e);if(!i)return;i.removeAttribute("validation-state"),u.delete(i);const r=i.querySelector(".p-form__errors");r&&(r.innerHTML="")}function v(t,e,i,r=!1){if(!i)return;if(i.errors<=0)return;!function(t,e,i,r=!1){const n=p(t,e);if(!n)return;let a="valid";i.errors.length>0&&(a=i.potentiallyValid&&!r?"potentially-valid":"invalid"),n.setAttribute("validation-state",a)}(t,e,i,r);const n=p(t,e),a=n.querySelector(".p-form__errors");if(!a)return;const s=a.querySelector(":scope > ul")||document.createElement("ul");i.errors.forEach(t=>{const e=document.createElement("li");e.innerText=t,s.append(e)}),a.append(s),u.set(n,i)}const y=new class{_map=new WeakMap;add(t,e){this._map.has(t)||this._map.set(t,new Set),this._map.get(t).add(e)}delete(t,e){this._map.has(t)&&this._map.get(t).delete(e)}clear(t){this._map.delete(t)}get(t){return this._map.get(t)}};function m(t,e,i=!1,n=new WeakMap){const l=function(t,e){let i=null;const r=p(t,e);if(!r)return i;const n=r.querySelectorAll(`:scope [name="${e}"], :scope [name^="${e}["]`);return 1===n.length?i=f(n[0]):n.length>1&&(i=[],n.forEach(t=>{const e=f(t);null!==e&&("]"===t.getAttribute("name").substr(-1)?(i&&"Array"===i.constructor.name||(i=[]),i.push(e)):i=e)})),i}(t,e),c=p(t,e);if(!c)return o.error(["handler not found"]);if(n.has(c))return n.get(c);const d=o.success(),u=function(t){if(!x.has(t)){const e=t.getAttribute("validation");if(e){const i=JSON.parse(r.decode(e)).map(t=>{try{return a.fromJsonObject(t)}catch(t){return null}});x.set(t,i.filter(t=>t instanceof a))}}return x.get(t)}(c);try{const i=new FormData(t),r={};for(let[t,e]of i.entries())r[t]=e;u.forEach(i=>{if(i instanceof s&&i.setData(r),i instanceof h){const r=p(t,i._field);y.add(r,e)}d.combine(i.validate(l))})}catch(t){}n.set(c,d);const g=y.get(c);return g&&g.forEach(e=>{m(t,e,!0,n)}),_(t,e),!d.errors||d.potentiallyValid&&!i||v(t,e,d,i),t.dispatchEvent(new CustomEvent("form-handler-validation",{detail:{handlerName:e,result:d},bubbles:!0,cancellable:!1})),d}function g(t){const e=new b;if(!(t instanceof HTMLFormElement))return console.error("not a form element"),e;const i=new WeakMap;return t.querySelectorAll(".p-form__field[validation]").forEach(r=>{const n=r.getAttribute("handler-name"),a=m(t,n,!0,i);e.append(n,a)}),t.dispatchEvent(new CustomEvent("form-validation",{detail:{result:e},bubbles:!0,cancellable:!1})),e}const x=new WeakMap;class b{constructor(){this._isValid=!0,this._results=new Map}get isValid(){return this._isValid}get results(){return this._results}append(t,e){this._results.set(t,e),this._isValid=this._isValid&&0===e.errors.length}}let w=new WeakSet;function E(t=document){w.has(t)||(w.add(t),t.addEventListener("submit",t=>{const e=g(t.path&&t.path[0]||t.target);t.detail=t.detail||{},t.detail["@packaged/form"]={validation:e},e.isValid||t.preventDefault()}),t.addEventListener("reset",t=>{const e=t.path&&t.path[0]||t.target;e.querySelectorAll(".p-form__field[handler-name]").forEach(t=>_(e,t.getAttribute("handler-name")))}),t.addEventListener("input",t=>{A(t.path&&t.path[0]||t.target,!1)}),t.addEventListener("focusout",t=>{A(t.path&&t.path[0]||t.target,!0)}))}function A(t,e=!1){const i=t.closest(".p-form__field");if(!i||!i.hasAttribute("handler-name"))return;const r=i.getAttribute("handler-name"),n=t.closest("form");n&&m(n,r,e)}E(),t.ValidationResults=b,t.addErrors=v,t.clearErrors=_,t.getErrors=function(t,e){const i=p(t,e);return u.get(i)},t.init=E,t.validateForm=g,t.validateHandler=m,Object.defineProperty(t,"__esModule",{value:!0})});

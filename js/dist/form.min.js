!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Form={})}(this,(function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r={exports:{}};
/*! https://mths.be/base64 v1.0.0 by @mathias | MIT license */
!function(e,r){!function(n){var s=r,a=e&&e.exports==s&&e,i="object"==typeof t&&t;i.global!==i&&i.window!==i||(n=i);var o=function(e){this.message=e};(o.prototype=new Error).name="InvalidCharacterError";var l=function(e){throw new o(e)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=/[\t\n\f\r ]/g,d={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&l("The string to be encoded contains characters outside of the Latin1 range.");for(var t,r,n,s,a=e.length%3,i="",o=-1,u=e.length-a;++o<u;)t=e.charCodeAt(o)<<16,r=e.charCodeAt(++o)<<8,n=e.charCodeAt(++o),i+=c.charAt((s=t+r+n)>>18&63)+c.charAt(s>>12&63)+c.charAt(s>>6&63)+c.charAt(63&s);return 2==a?(t=e.charCodeAt(o)<<8,r=e.charCodeAt(++o),i+=c.charAt((s=t+r)>>10)+c.charAt(s>>4&63)+c.charAt(s<<2&63)+"="):1==a&&(s=e.charCodeAt(o),i+=c.charAt(s>>2)+c.charAt(s<<4&63)+"=="),i},decode:function(e){var t=(e=String(e).replace(u,"")).length;t%4==0&&(t=(e=e.replace(/==?$/,"")).length),(t%4==1||/[^+a-zA-Z0-9/]/.test(e))&&l("Invalid character: the string to be decoded is not correctly encoded.");for(var r,n,s=0,a="",i=-1;++i<t;)n=c.indexOf(e.charAt(i)),r=s%4?64*r+n:n,s++%4&&(a+=String.fromCharCode(255&r>>(-2*s&6)));return a},version:"1.0.0"};if(s&&!s.nodeType)if(a)a.exports=d;else for(var h in d)d.hasOwnProperty(h)&&(s[h]=d[h]);else n.base64=d}(t)}(r,r.exports);var n=r.exports;function s(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const a=new Map;class i{static fromJsonObject(e){if(!a.has(e.t))throw"unrecognised type "+e.t;return a.get(e.t).deserialize(e.c)}static deserialize(e){return new this}validate(e){throw"validate not implemented on "+this.constructor.name}}class o extends i{constructor(){super(...arguments),s(this,"_data",{})}setData(e){this._data=e}getData(){return this._data}}class l{constructor(e,t){this._errors=e||[],this._potentiallyValid=t||!1}get errors(){return this._errors}get potentiallyValid(){return this._potentiallyValid}static success(){return new l([],!0)}static potentiallyValid(){return new l(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],!0)}static error(){return new l(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],!1)}combine(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];t.forEach((e=>{e instanceof l&&(this._errors.push(...e._errors),this._potentiallyValid=this._potentiallyValid&&e._potentiallyValid)}))}}function c(e,t){a.set(e,t)}class u extends i{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];super(),this._allowedValues=e||[],this._caseSensitive=!!t,this._negate=!!r}static deserialize(e){return new this(e.allowedValues||[],!!e.caseSensitive,!!e.negate)}validate(e){if(this._allowedValues.length){const t=new RegExp(this._allowedValues.join("|"),this._caseSensitive?"":"i");if(this._negate^!t.test(e))return l.error(["not a valid value"])}else if(this._negate^(null!==e&&""!==e))return l.error(["not a valid value"]);return l.success()}}class d extends i{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"does not match regular expression";super(),this._pattern=e,this._message=t}static deserialize(e){return new this(e.pattern,e.message)}validate(e){let t=this._pattern;if("string"==typeof t){const e=/\/(.*)\/(.*)/.exec(t);if(!e)return l.error(["not a valid regular expression"]);t=new RegExp(e[1],e[2])}return t instanceof RegExp?t.test(e)?l.success():l.error([this._message]):l.error(["not a valid regular expression"])}}class h extends o{constructor(e){super(),this._field=e}static deserialize(e){return new this(e.field)}validate(e){const t=this.getData(),r=t.hasOwnProperty(this._field)?t[this._field]:null;return r!==e?r.substr(0,e.length)===e?l.potentiallyValid(["value does not match"]):l.error(["value does not match"]):l.success()}}c("Equal",class extends i{constructor(e){super(),this._expect=e}static deserialize(e){return new this(e.expect)}validate(e){return e!==this._expect?l.error(["value does not match"]):l.success()}}),c("NotEqual",class extends i{constructor(e){super(),this._expect=e}static deserialize(e){return new this(e.expect)}validate(e){return e===this._expect?l.error(["value must not match"]):l.success()}}),c("Enum",u),c("ConstEnum",class extends u{}),c("Bool",class extends i{validate(e){if(null==e)return l.error(["Invalid boolean value"]);if("boolean"!=typeof e)if("string"==typeof e){if(!/true|false|0|1/.test(e.toLowerCase()))return l.error(["Invalid boolean value"])}else if("number"==typeof e&&0!==e&&1!==e)return l.error(["Invalid boolean value"]);return l.success()}}),c("String",class extends i{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;super(),this._minLength=e,this._maxLength=t}static deserialize(e){return new this(e.minLength,e.maxLength)}validate(e){return"string"!=typeof e?l.error(["not a valid value"]):this._minLength>0&&e.length<this._minLength?l.potentiallyValid(["must be at least "+this._minLength+" characters"]):this._maxLength>0&&e.length>this._maxLength?l.error(["must be no more than "+this._maxLength+" characters"]):l.success()}}),c("Required",class extends i{validate(e){return null==e||""===e?l.error(["required"]):l.success()}}),c("Multi",class extends i{constructor(e){super(),this._validators=e||[]}static deserialize(e){return new this(e.validators)}validate(e){let t=l.success();return this._validators.forEach((r=>{const n=i.fromObject(r);t.combine(n.validate(e))})),t}}),c("Regex",d),c("Email",class extends d{constructor(){super(/^[_a-zA-Z0-9+\-]+(\.[_a-zA-Z0-9+\-]+)*@[a-zA-Z0-9\-]+(\.[a-zA-Z0-9\-]+)*(\.[a-zA-Z]{2,})$/,arguments.length>0&&void 0!==arguments[0]?arguments[0]:"invalid email address")}static deserialize(e){return new this(e.message)}}),c("IPv4",class extends d{constructor(){super("/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/",arguments.length>0&&void 0!==arguments[0]?arguments[0]:"invalid IPv4 address")}static deserialize(e){return new this(e.message)}}),c("Confirmation",h),c("FileSize",class extends i{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(super(),null===e)throw"maxSize must be set";this._maxSize=e}static deserialize(e){return new this(e.maxSize)}validate(e){return"size"in e&&e.size>1024*this._maxSize*1024?l.error(["File upload cannot be more than "+this._maxSize+"mb in size"]):l.success()}});const f=new WeakMap;function p(e){return"checkbox"!==e.type&&"radio"!==e.type&&"file"!==e.type||e instanceof HTMLSelectElement||e.checked?e.value:"file"===e.type&&e.files[0]?e.files[0]:null}function g(e,t){return e.querySelector(`.p-form__field[handler-name="${t}"]`)}function m(e,t){let r=null;const n=g(e,t);if(!n)return r;const s=n.querySelectorAll(`:scope [name="${t}"], :scope [name^="${t}["]`);return 1===s.length?r=p(s[0]):s.length>1&&(r=[],s.forEach((e=>{const t=p(e);null!==t&&("]"===e.getAttribute("name").substr(-1)?(r&&"Array"===r.constructor.name||(r=[]),r.push(t)):r=t)}))),r}function v(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=g(e,t);if(!s)return;let a="valid";r.errors.length>0&&(a=r.potentiallyValid&&!n?"potentially-valid":"invalid"),s.setAttribute("validation-state",a)}function _(e,t){const r=g(e,t);if(!r)return;r.removeAttribute("validation-state"),f.delete(r);const n=r.querySelector(".p-form__errors");n&&(n.innerHTML="")}function b(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!r)return;if(r.errors<=0)return;v(e,t,r,n);const s=g(e,t),a=s.querySelector(".p-form__errors");if(!a)return;const i=a.querySelector(":scope > ul")||document.createElement("ul");r.errors.forEach((e=>{const t=document.createElement("li");t.innerText=e,i.append(t)})),a.append(i),f.set(s,r)}const y=new class{constructor(){s(this,"_map",new WeakMap)}add(e,t){this._map.has(e)||this._map.set(e,new Set),this._map.get(e).add(t)}delete(e,t){this._map.has(e)&&this._map.get(e).delete(t)}clear(e){this._map.delete(e)}get(e){return this._map.get(e)}};function w(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new WeakMap;const s=m(e,t),a=g(e,t);if(!a)return l.error(["handler not found"]);if(n.has(a))return n.get(a);const i=l.success(),c=E(a);try{const r=new FormData(e),n={};for(let[e,t]of r.entries())n[e]=t;c.forEach((r=>{if(r instanceof o&&r.setData(n),r instanceof h){const n=g(e,r._field);y.add(n,t)}i.combine(r.validate(s))}))}catch(e){}n.set(a,i);const u=y.get(a);return u&&u.forEach((t=>{w(e,t,!0,n)})),_(e,t),!i.errors||i.potentiallyValid&&!r||b(e,t,i,r),e.dispatchEvent(new CustomEvent("form-handler-validation",{detail:{handlerName:t,result:i},bubbles:!0,cancellable:!1})),i}function x(e){const t=new z;if(!(e instanceof HTMLFormElement))return console.error("not a form element"),t;const r=new WeakMap;return e.querySelectorAll(".p-form__field[validation]").forEach((n=>{const s=n.getAttribute("handler-name"),a=w(e,s,!0,r);t.append(s,a)})),e.dispatchEvent(new CustomEvent("form-validation",{detail:{result:t},bubbles:!0,cancellable:!1})),t}const A=new WeakMap;function E(e){if(!A.has(e)){const t=e.getAttribute("validation");if(t){const r=JSON.parse(n.decode(t)).map((e=>{try{return i.fromJsonObject(e)}catch(e){return null}}));A.set(e,r.filter((e=>e instanceof i)))}}return A.get(e)}class z{constructor(){this._isValid=!0,this._results=new Map}get isValid(){return this._isValid}get results(){return this._results}append(e,t){this._results.set(e,t),this._isValid=this._isValid&&0===t.errors.length}}let S=new WeakSet;function V(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document;S.has(e)||(S.add(e),e.addEventListener("submit",(e=>{const t=x(e.path&&e.path[0]||e.target);e.detail=e.detail||{},e.detail["@packaged/form"]={validation:t},t.isValid||e.preventDefault()})),e.addEventListener("reset",(e=>{const t=e.path&&e.path[0]||e.target;t.querySelectorAll(".p-form__field[handler-name]").forEach((e=>_(t,e.getAttribute("handler-name"))))})),e.addEventListener("input",(e=>{L(e.path&&e.path[0]||e.target,!1)})),e.addEventListener("focusout",(e=>{L(e.path&&e.path[0]||e.target,!0)})))}function L(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=e.closest(".p-form__field");if(!r||!r.hasAttribute("handler-name"))return;const n=r.getAttribute("handler-name"),s=e.closest("form");s&&w(s,n,t)}V(),e.ValidationResults=z,e.addErrors=b,e.clearErrors=_,e.getErrors=function(e,t){const r=g(e,t);return f.get(r)},e.init=V,e.validateForm=x,e.validateHandler=w,Object.defineProperty(e,"__esModule",{value:!0})}));
